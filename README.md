# üìä Marketplace sales dynamic

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç ETL-–ø–∞–π–ø–ª–∞–π–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Apache Airflow** –∏ **Clickhouse** –≤ —Å—Ä–µ–¥–µ **Yandex.Cloud** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ. –î–∞–Ω–Ω—ã–µ –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ **Yandex DataLens**

## üìö –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞
![Reference Image](/images/schema.png)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ 10 –∞—Ä—Ç–∏–∫—É–ª–∞–º —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º Python-—Å–∫—Ä–∏–ø—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ DAG'–∞ –≤ Apache Airflow –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 23:00 –ú–°–ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (ClickHouse)
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ [–¥–∞—à–±–æ—Ä–¥–∞](https://datalens.yandex/uya8ne6daz2gg) –≤ **Data Lens**

## üîÑ –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º
 ### –ê—Ä–µ–Ω–¥–∞ **VPS —Å–µ—Ä–≤–µ—Ä–∞** –≤ —Å—Ä–µ–¥–µ **Yandex.Cloud**:
 - –ë—ã–ª —Å–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ **Airflow** –∏ **ClickHouse**

 ### –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã **Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** –¥–ª—è **Apache Airflow** –∏ **Clickhouse**
 - –î–ª—è **Apache Airflow** –∏ **ClickHouse** –±—ã–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã **Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
 ![Reference Image](/images/services.png)
 - –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ DAG'–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ETL-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### **–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö**:
- –°–æ–∑–¥–∞–Ω Python-—Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Å–ø–∏—Å–∫—É –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ API –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ (nmld) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è GET-–∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É requests –∫ API –∏ –ø–∞—Ä—Å—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
- –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö **ClickHouse** —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–∞—Ç—ã, –∞—Ä—Ç–∏–∫—É–ª–æ–≤ —Ç–æ–≤–∞—Ä–∞ –∏ —Å—É–º–º–∞—Ä–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤

### **–ó–∞–ø—É—Å–∫ DAG'–∞ –≤ Apache Airflow**:
   - –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω DAG –≤ **Apache Airflow**, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 23:00 –ú–°–ö
![Reference Image](/images/dag_screen.png)
   - DAG –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö, –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –∑–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ClickHouse**:
   - –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö **ClickHouse**, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
   - –í ClickHouse —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–ª—è–º–∏: date, nmld (–∞—Ä—Ç–∏–∫—É–ª) –∏ stocks (–æ—Å—Ç–∞—Ç–∫–∏)

### **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂**:
   - –ù–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –±—ã–ª–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –≤–∏—Ç—Ä–∏–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂, –≥–¥–µ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –∞—Ä—Ç–∏–∫—É–ª—É
   - –í–∏—Ç—Ä–∏–Ω–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É

### **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ Yandex DataLens**:
   - –°–æ–∑–¥–∞–Ω [–¥–∞—à–±–æ—Ä–¥](https://datalens.yandex/uya8ne6daz2gg) –≤ **Yandex DataLens**, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É –ø—Ä–æ–¥–∞–∂ —Ç–æ–≤–∞—Ä–æ–≤
   - –ù–∞ –≥—Ä–∞—Ñ–∏–∫–µ –ø–æ –æ—Å–∏ X –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –¥–∞—Ç—ã, –∞ –ø–æ –æ—Å–∏ Y ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ (orders)

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π **Git**
- –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω **Git**
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –±—ã–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ **GitHub**

## üóÑÔ∏è –í—ã–±–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å **ClickHouse** –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ClickHouse —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- **–ì–∏–±–∫–æ—Å—Ç—å**: SQL-–ø–æ–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ClickHouse –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–∏—Ç—Ä–∏–Ω –∏ –æ—Ç—á–µ—Ç–æ–≤

## üìà DataLens Setup

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö** –≤ **Yandex DataLens** –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö **ClickHouse**
2. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂** —Å –ø–æ–º–æ—â—å—é SQL-–∑–∞–ø—Ä–æ—Å–∞
```sql
CREATE VIEW default.sales_dynamic
(

    `date` Date,
    `nmld` Int64,
    `orders` Int64
)
AS SELECT
          date,
          nmld,
          greatest(prev_stocks - stocks, 0) AS orders
FROM
(
    SELECT
            date,
            nmld,
            stocks, 
            lagInFrame(stocks) OVER (PARTITION BY nmld ORDER BY date) AS prev_stocks
    FROM default.stock) AS stocks_lag
WHERE date > (select min(date) from default.stock)
ORDER BY
        date ASC, nmld ASC
```
3. **–°–æ–∑–¥–∞–Ω–∏–µ [–¥–∞—à–±–æ—Ä–¥–∞](https://datalens.yandex/uya8ne6daz2gg)** –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –¥–∏–Ω–∞–º–∏–∫–∏ –ø—Ä–æ–¥–∞–∂

## ‚öô –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- **Apache Airflow** ‚Äì —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DAG'–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- **ClickHouse** ‚Äì –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- **Postgres 13** ‚Äì –±–∞–∑–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö Apache Airflow 
- **Redis** ‚Äì –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è CeleryExecutor –≤ Airflow
- **Docker, Docker Compose** ‚Äì –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **Python, SQL** ‚Äì –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ 
- **DBeaver** ‚Äì —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ClickHouse —á–µ—Ä–µ–∑ SQL-–∑–∞–ø—Ä–æ—Å—ã  
- **Git –∏ GitHub** ‚Äì –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π